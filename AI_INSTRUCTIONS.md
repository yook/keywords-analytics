# Инструкция для AI: интеграция UI с Dexie (IndexedDB) и архитектура проекта

Цель: описать, как проект организован, как UI связывается с локальной БД через Dexie (IndexedDB), ответственности слоёв и практические шаги для внесения изменений.

────────────────────────────────┐
│ Presentation Layer │
│ (Vue Components, Views, Router) │
└──────────────┬──────────────────────┘
│
┌──────────────▼──────────────────────┐
│ Application Layer │
│ (Pinia Stores, Composables) │
└──────────────┬──────────────────────┘
│
┌──────────────▼──────────────────────┐
│ Domain Layer │
│ (Business Logic, Models, Services) │
└──────────────┬──────────────────────┘
│
┌──────────────▼──────────────────────┐
│ Data Layer │
│ (Dexie / IndexedDB, API, Persistence) │
└─────────────────────────────────────┘

1. Коротко о роли каждого слоя

- Presentation: только UI — визуализация состояния и обработка пользовательских событий. Компоненты не должны содержать бизнес-логику и прямые вызовы IndexedDB.
- Application: Pinia stores содержат состояние (loading, lastResult, error и т.д.). Composables (`useDexie`) управляют lifecycle подключения к Dexie/IndexedDB и предоставляют удобные методы для операций CRUD и транзакций.
- Domain: сервисы в `src/services/` инкапсулируют сценарии/правила приложения (например, загрузка проектов, импорт/экспорт). Сервисы используют composables и stores для выполнения задач и обработки ошибок.
- Data: реализация хранения данных через Dexie (IndexedDB). Сюда входят схемы, миграции и вспомогательные утилиты работы с индексами и транзакциями.

2. Где что находится (файловая карта)

- Presentation: [src/components](src/components), [src/views](src/views), [src/router](src/router).
- Stores: [src/stores](src/stores) — Pinia; хранит состояние приложения и метаданные (loading, error, lastResult и т.п.).
- Composables: [src/composables/useDexie.ts](src/composables/useDexie.ts) — инициализация Dexie, методы доступа (`get`, `put`, `bulkPut`, `query`, `transaction`), обработка миграций и закрытия соединения.
- Services: [src/services/\*](src/services) — domain logic, вызывает composables и обновляет stores.
- Data schema/типизация: [src/types/schema.ts](src/types/schema.ts) — модели таблиц/объектов для Dexie.

3. Правила разработки для AI

- Не кладите доступ к IndexedDB прямо в компоненты — используйте сервисы и composables (`useDexie`).
- Stores хранят только состояние/флаги и простые actions; все сложные операции делайте в сервисах.
- Composables управляют side-effects: инициализация Dexie, выполнение транзакций, откат/миграции, обработка ошибок и логирование.
- Все ошибки при работе с БД должны логироваться и попадать в `store.error`.

4. Типовой рабочий сценарий (для AI-реализаций)

- Presentation вызывает сервис (например, `projectsService.loadProjects()`).
- Сервис вызывает `useDexie()` (или напрямую методы composable) для выполнения операций (CRUD/запросы) и обновляет Pinia store (`loading`, `lastResult`, `error`).
- Компонент читает `store` (через `storeToRefs`) и отображает данные или состояния загрузки/ошибки.

5. Частые проблемы и как их диагностировать (IndexedDB / Dexie)

- Ошибки версии БД при миграциях: проверьте логику версионирования в `useDexie` и корректность схемы в [src/types/schema.ts](src/types/schema.ts).
- `QuotaExceededError` / переполнение хранилища: данные слишком большие для IndexedDB — подумайте об архивировании, удалении старых данных или использовании внешнего API для больших файлов.
- Транзакция откатится при асинхронной операции вне контекста транзакции: используйте `db.transaction('rw', table, async () => { ... })` и избегайте выхода в асинхронный код без await внутри транзакции.
- Конкурентный доступ: при параллельных записях убедитесь, что используете корректные транзакции и индексы, избегая гонок.

6. Как запускать и тестировать локально

```bash
# установить зависимости
npm install

# запустить dev сервер
npm run dev

# в браузере открыть http://localhost:5173 (или порт, указанный Vite)
```

7. Как добавить новый бизнес-запрос / операцию с БД

- Создайте функцию в `src/services/` (domain). Она должна:
  - вызывать `useDexie()` для выполнения операций (например, `db.table.where(...).toArray()` или `bulkPut`)
  - обновлять соответствующий Pinia store (loading/result/error)
  - обрабатывать и логировать ошибки, при необходимости пробрасывать их выше

Пример шаблона сервиса:

- Получение данных: вызвать `const { db } = useDexie()` → `await db.table.toArray()` → commit в store.
- Импорт/экспорт: выполнять в транзакции `db.transaction('rw', db.table, async () => { ... })` и отслеживать прогресс через store.

8. Комментарий по Pinia

- Pinia уже установлен. Используйте `storeToRefs(store)` в компонентах для реактивного присоединения.

9. Что делать если AI должен править код

- Изменения структуры: редактируйте только модули `stores/`, `composables/`, `services/`, `components/` согласно новой архитектуре Dexie.
- Перед изменениями: запустите `npm run dev` и убедитесь, что операции с IndexedDB работают (открыть DevTools → Application → IndexedDB).

10. Контактные команды для разработчика

- Перезапустить vite, если завис процессы: `pkill -f vite || true && npm run dev`.

Если нужно — автоматически сгенерирую примеры сервисов, миграций Dexie или тесты. Также могу сохранить этот файл в другом формате — скажите куда.

\*\*\* Конец инструкции
