(function(){"use strict";let j=null,P=0;const w=new Map,q=new Map;function E(){var t;if(j)return j;if(typeof SharedWorker>"u")throw new Error("SharedWorker is not supported");const o=new SharedWorker(new URL("/assets/lemma-dict.shared-BZW7bCOX.js",self.location.href),{type:"module",name:"lemma-dict-shared"}).port;o.onmessage=s=>{const r=s.data||{};if(r.type==="lemma:entries"&&r.requestId){const i=w.get(r.requestId);i&&(w.delete(r.requestId),i.resolve(r.entries||{}))}if(r.type==="lemma:error"&&r.requestId){const i=w.get(r.requestId);i&&(w.delete(r.requestId),i.reject(new Error(r.error||"lemma shared error")))}};try{(t=o.start)==null||t.call(o)}catch{}return j=o,o}async function x(d){if(!d.length)return;const o=E(),t=`${Date.now()}-${P++}`,s=new Promise((i,S)=>{w.set(t,{resolve:i,reject:S})});o.postMessage({type:"lemma:get",requestId:t,words:d});const r=await s;Object.entries(r||{}).forEach(([i,S])=>{q.has(i)||q.set(i,S||null)})}async function L(d){const o=[];for(const t of d){const s=String(t||"").toLowerCase();s&&(q.has(s)||o.push(s))}o.length&&await x(o)}const v="app-db";function _(){return new Promise((d,o)=>{const t=indexedDB.open(v);t.onsuccess=()=>d(t.result),t.onerror=()=>o(t.error),t.onupgradeneeded=()=>{}})}self.addEventListener("message",async d=>{const{type:o,payload:t,requestId:s}=d.data||{};try{if(o!=="morphology")return;const r=t!=null&&t.projectId?String(t.projectId):"anon",i=t!=null&&t.batchSize?Number(t.batchSize):10;async function S(k){const g=String(k||"").trim().toLowerCase();if(!g)return{lemma:"",tags:"",grammemes:""};const f=g.split(/\s+/g);try{await L(f);const p=[],m=new Set;for(const c of f){const n=q.get(String(c).toLowerCase())||null,I=n?n.lemma:c;p.push(I),n!=null&&n.grammemes&&n.grammemes.forEach(y=>m.add(y))}const u=p.join(" "),a=[...p].sort((c,n)=>c.localeCompare(n,"ru")).join(","),e=[...m].sort((c,n)=>c.localeCompare(n,"ru")).join(",");return{lemma:u,tags:a,grammemes:e}}catch(p){console.warn("[morphology.worker] normalizeKeywordText failed for",g,p);const u=[...f.filter(a=>typeof a=="string"&&a)].sort((a,e)=>a.localeCompare(e,"ru")).join(",");return{lemma:g,tags:u,grammemes:""}}}const C=await _();if(!C.objectStoreNames.contains("keywords")){self.postMessage({type:"morphology:done",requestId:s,processed:0,total:0});return}let h=0;if(await new Promise((k,g)=>{try{const m=C.transaction("keywords","readonly").objectStore("keywords").openCursor();m.onsuccess=u=>{const a=u.target.result;if(!a)return k();const e=a.value||{};String(e.projectId||"anon")===r&&!e.morphology_processed&&h++,a.continue()},m.onerror=()=>g(m.error)}catch(f){g(f)}}),h===0){self.postMessage({type:"morphology:done",requestId:s,processed:0,total:0});return}let b=0,l=[];await new Promise((k,g)=>{try{const p=C.transaction("keywords","readwrite").objectStore("keywords"),m=p.openCursor();m.onsuccess=async u=>{const a=u.target.result;if(!a){if(l.length>0){for(const c of l)p.put(c);b+=l.length,self.postMessage({type:"morphology:progress",requestId:s,processed:b,total:h}),l=[]}return k()}const e=a.value||{};if(String(e.projectId||"anon")===r&&!e.morphology_processed){try{const c=e.keyword||"",{lemma:n,tags:I,grammemes:y}=await S(c);e.lemma=n,e.tags=I,y&&(e.grammemes=y),e.morphology_processed=1,l.push(e)}catch{const n=String(e.keyword||"").trim().toLowerCase(),y=[...n.split(/\s+/g).filter(M=>!!M)].sort((M,z)=>M.localeCompare(z,"ru")).join(",");e.lemma=e.lemma||n,e.tags=e.tags||y,e.grammemes=e.grammemes||"",e.morphology_processed=1,l.push(e)}if(l.length>=i){for(const c of l)p.put(c);b+=l.length,self.postMessage({type:"morphology:progress",requestId:s,processed:b,total:h}),l=[]}}a.continue()},m.onerror=()=>g(m.error)}catch(f){g(f)}}),self.postMessage({type:"morphology:done",requestId:s,processed:b||h,total:h})}catch(r){self.postMessage({type:"error",requestId:s,error:String(r)})}})})();
