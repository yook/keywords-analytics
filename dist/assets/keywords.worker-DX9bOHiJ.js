(function(){"use strict";const k="app-db";function M(){return new Promise((d,a)=>{const e=indexedDB.open(k);e.onsuccess=()=>d(e.result),e.onerror=()=>a(e.error),e.onupgradeneeded=()=>{}})}async function h(d,a,e){return new Promise((s,o)=>{try{const t=d.transaction(a,"readwrite"),y=t.objectStore(a);for(const l of e)y.put(l);t.oncomplete=()=>s(),t.onerror=()=>o(t.error),t.onabort=()=>o(t.error||new Error("transaction aborted"))}catch(t){o(t)}})}self.addEventListener("message",async d=>{const{type:a,payload:e,requestId:s}=d.data||{};try{if(a==="saveKeywords"){let o=[];const t=await M();if(!t.objectStoreNames.contains("keywords"))throw new Error("keywords object store not found in IndexedDB; ensure main thread created schema");if(Array.isArray(e))o=e;else if(e&&typeof e=="object"&&typeof e.raw=="string"){const c=e.raw,i=e.projectId||"anon",b=Number(e.chunkSize)||2e3,u=c.split(/[\n,]+/).map(r=>r.trim()).filter(Boolean),K=Math.max(500,Math.min(1e4,b)),f=new Set;for(let r=0;r<u.length;r++){const g=u[r],w=`${i}::${encodeURIComponent(g.trim().toLowerCase())}`;f.add(w)}const m=f.size;let p=0,n=[];for(let r=0;r<u.length;r++){const g=u[r],w=`${i}::${encodeURIComponent(g.trim().toLowerCase())}`;if(!f.has(w))continue;f.delete(w);const S=new Date().toISOString();n.push({id:w,projectId:i,keyword:g,created_at:S}),n.length>=K&&(await h(t,"keywords",n),p+=n.length,self.postMessage({type:"saveKeywords:progress",requestId:s,written:p,total:m}),n=[])}n.length>0&&(await h(t,"keywords",n),p+=n.length,self.postMessage({type:"saveKeywords:progress",requestId:s,written:p,total:m})),self.postMessage({type:"saveKeywords:done",requestId:s,count:p});return}else{self.postMessage({type:"saveKeywords:done",requestId:s,count:0});return}const y=1e3;let l=0;for(let c=0;c<o.length;c+=y){const i=o.slice(c,c+y);await h(t,"keywords",i),l+=i.length,self.postMessage({type:"saveKeywords:progress",requestId:s,written:l,total:o.length})}self.postMessage({type:"saveKeywords:done",requestId:s,count:l})}}catch(o){self.postMessage({type:"error",requestId:s,error:String(o)})}})})();
